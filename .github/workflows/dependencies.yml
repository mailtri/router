name: Dependency Check

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated packages
        run: |
          npm outdated || echo "Some packages are outdated"

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate || echo "Security audit completed with findings"

      - name: Check for available updates
        run: |
          echo "Checking for outdated packages..."
          npm outdated || echo "Some packages are outdated"

          # Check if there are any updates available
          if npm outdated > /dev/null 2>&1; then
            echo "✅ All dependencies are up to date"
          else
            echo "❌ Outdated dependencies found:"
            npm outdated
            echo ""
            echo "Please manually update dependencies by running:"
            echo "  npm update"
            echo "  npm audit fix"
            echo ""
            echo "Then commit the changes and push to your branch."
            exit 1
          fi

      - name: Check for security vulnerabilities
        run: |
          echo "Running security audit..."
          if npm audit --audit-level=high; then
            echo "✅ No high-severity vulnerabilities found"
          else
            echo "❌ High-severity vulnerabilities detected!"
            echo "Please review and fix security issues manually."
            exit 1
          fi

      - name: Create issue for outdated dependencies
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = '📦 Dependencies need updating';
            const body = `## Dependency Update Required

            The weekly dependency check has detected outdated packages that need manual review and updating.

            ### Next Steps:
            1. Review the outdated packages listed in the workflow logs
            2. Update dependencies manually:
               \`\`\`bash
               npm update
               npm audit fix
               \`\`\`
            3. Test the changes thoroughly
            4. Commit and push the updates

            ### Security Note:
            Please prioritize security updates and test thoroughly before merging.

            ---
            *This issue was automatically created by the dependency check workflow.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'maintenance']
              });
              console.log('Created new issue for outdated dependencies');
            } else {
              console.log('Issue already exists for outdated dependencies');
            }
