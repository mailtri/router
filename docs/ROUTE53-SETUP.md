# Route 53 Setup Guide

This guide covers integrating your existing Route 53 hosted zone with the Mailtri Router infrastructure.

## Prerequisites

- Existing Route 53 hosted zone for your domain
- Domain registered and managed in Route 53
- AWS CLI configured with appropriate permissions

## CDK Deployment with Route 53

### 1. Deploy with Domain Context

```bash
# Deploy with your domain name
npx cdk deploy --context domainName=yourdomain.com

# Or set as environment variable
export CDK_DOMAIN_NAME=yourdomain.com
npx cdk deploy
```

### 2. Verify Deployment

```bash
# Check Route 53 records
aws route53 list-resource-record-sets --hosted-zone-id YOUR_HOSTED_ZONE_ID

# Check SES domain verification
aws ses get-identity-verification-attributes --identities yourdomain.com
```

## DNS Records Created

The CDK stack will create the following DNS records:

### 1. SPF Record
```
Type: TXT
Name: yourdomain.com
Value: v=spf1 include:amazonses.com ~all
```

### 2. DMARC Record
```
Type: TXT
Name: _dmarc.yourdomain.com
Value: v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain.com
```

### 3. SES Domain Verification
```
Type: TXT
Name: _amazonses.yourdomain.com
Value: [Generated by SES after domain verification]
```

### 4. DKIM Records (3 records)
```
Type: TXT
Name: dkim1._domainkey.yourdomain.com
Name: dkim2._domainkey.yourdomain.com
Name: dkim3._domainkey.yourdomain.com
Value: [Generated by SES after DKIM setup]
```

## Post-Deployment Configuration

### 1. Verify Domain in SES

```bash
# Start domain verification
aws ses verify-domain-identity --domain yourdomain.com

# Get verification token
aws ses get-identity-verification-attributes --identities yourdomain.com
```

### 2. Update SES Domain Verification Record

After getting the verification token from SES:

```bash
# Update the TXT record with the actual verification token
aws route53 change-resource-record-sets --hosted-zone-id YOUR_HOSTED_ZONE_ID --change-batch '{
  "Changes": [{
    "Action": "UPSERT",
    "ResourceRecordSet": {
      "Name": "_amazonses.yourdomain.com",
      "Type": "TXT",
      "TTL": 300,
      "ResourceRecords": [{"Value": "\"SES_VERIFICATION_TOKEN\""}]
    }
  }]
}'
```

### 3. Enable DKIM for Domain

```bash
# Enable DKIM for the domain
aws ses put-identity-dkim-attributes --identity yourdomain.com --dkim-enabled

# Get DKIM tokens
aws ses get-identity-dkim-attributes --identities yourdomain.com
```

### 4. Update DKIM Records

Update the three DKIM records with the actual tokens from SES:

```bash
# Update DKIM record 1
aws route53 change-resource-record-sets --hosted-zone-id YOUR_HOSTED_ZONE_ID --change-batch '{
  "Changes": [{
    "Action": "UPSERT",
    "ResourceRecordSet": {
      "Name": "dkim1._domainkey.yourdomain.com",
      "Type": "TXT",
      "TTL": 300,
      "ResourceRecords": [{"Value": "\"DKIM_TOKEN_1\""}]
    }
  }]
}'

# Repeat for dkim2 and dkim3 with their respective tokens
```

## Email Authentication Setup

### SPF Record
The SPF record authorizes Amazon SES to send emails on behalf of your domain:

```
v=spf1 include:amazonses.com ~all
```

### DMARC Record
The DMARC record provides instructions for email authentication:

```
v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain.com
```

- `p=quarantine`: Move failed emails to spam folder
- `rua=mailto:dmarc@yourdomain.com`: Send DMARC reports to this email

### DKIM Records
DKIM provides cryptographic authentication for your emails.

## Testing Email Authentication

### 1. Check SPF Record

```bash
dig TXT yourdomain.com
```

### 2. Check DMARC Record

```bash
dig TXT _dmarc.yourdomain.com
```

### 3. Check DKIM Records

```bash
dig TXT dkim1._domainkey.yourdomain.com
dig TXT dkim2._domainkey.yourdomain.com
dig TXT dkim3._domainkey.yourdomain.com
```

### 4. Test Email Sending

```bash
# Send test email
aws ses send-email \
  --source "noreply@yourdomain.com" \
  --destination "ToAddresses=test@example.com" \
  --message "Subject={Data='Test Email'},Body={Text={Data='This is a test email'}}"
```

## Monitoring and Troubleshooting

### 1. Check SES Sending Statistics

```bash
aws ses get-send-statistics
```

### 2. Check Bounce and Complaint Rates

```bash
aws ses get-identity-mail-from-domain-attributes --identities yourdomain.com
```

### 3. Monitor DMARC Reports

Set up email monitoring for `dmarc@yourdomain.com` to receive DMARC reports.

### 4. Common Issues

**Domain Verification Failed:**
- Check TXT record is correctly set
- Wait for DNS propagation (up to 48 hours)
- Verify record name and value

**DKIM Authentication Failed:**
- Ensure all three DKIM records are set
- Check record names match exactly
- Verify tokens are correct

**SPF Authentication Failed:**
- Check SPF record syntax
- Ensure `include:amazonses.com` is present
- Verify record is at domain root

## Advanced Configuration

### 1. Custom DMARC Policy

For stricter email authentication:

```
v=DMARC1; p=reject; rua=mailto:dmarc@yourdomain.com; ruf=mailto:dmarc-failures@yourdomain.com
```

### 2. SPF with Additional Senders

If you send from other services:

```
v=spf1 include:amazonses.com include:_spf.google.com ~all
```

### 3. Subdomain Configuration

For subdomains (e.g., `mail.yourdomain.com`):

```bash
# Verify subdomain
aws ses verify-domain-identity --domain mail.yourdomain.com

# Create corresponding DNS records
```

## Security Best Practices

1. **Use Strong DMARC Policy**: Start with `p=quarantine`, then move to `p=reject`
2. **Monitor DMARC Reports**: Set up email monitoring for DMARC reports
3. **Regular DKIM Rotation**: Rotate DKIM keys periodically
4. **SPF Record Maintenance**: Keep SPF record updated with all sending services

## Cost Considerations

- **Route 53 Hosted Zone**: $0.50/month per hosted zone
- **DNS Queries**: $0.40 per million queries
- **SES**: $0.10 per 1,000 emails sent

## Support

- üìñ [Route 53 Documentation](https://docs.aws.amazon.com/route53/)
- üìñ [SES Documentation](https://docs.aws.amazon.com/ses/)
- üí¨ [Slack Community](https://slack.mailtri.com)
- üêõ [Issue Tracker](https://github.com/mailtri/router/issues)
